<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Math Kingdom! üè∞</title>
<link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;600;700;800&family=Fredoka+One&display=swap" rel="stylesheet">
<style>
:root {
  --sky: #74C0FC;
  --sun: #FFD43B;
  --green: #51CF66;
  --red: #FF6B6B;
  --purple: #CC5DE8;
  --orange: #FF922B;
  --pink: #F06595;
  --teal: #20C997;
  --bg: #0F1B2D;
  --card: #1A2F4A;
  --card2: #1E3A5F;
  --text: #E8F4FD;
  --muted: #7EB8D4;
  --xp-bar: #FFD43B;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: 'Baloo 2', cursive;
  background: var(--bg);
  min-height: 100vh;
  color: var(--text);
  overflow-x: hidden;
}

/* Starfield background */
#starfield {
  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  pointer-events: none; z-index: 0;
  background: radial-gradient(ellipse at 20% 50%, #0d2137 0%, #0F1B2D 70%);
}
.twinkling-star {
  position: absolute;
  border-radius: 50%;
  background: white;
  animation: twinkle var(--dur, 3s) ease-in-out infinite;
}
@keyframes twinkle {
  0%, 100% { opacity: 0.1; transform: scale(1); }
  50% { opacity: 1; transform: scale(1.3); }
}

.app {
  position: relative; z-index: 1;
  max-width: 680px;
  margin: 0 auto;
  padding: 16px;
  min-height: 100vh;
}

/* ===== TOP HUD ===== */
.hud {
  display: flex;
  align-items: center;
  justify-content: space-between;
  background: var(--card);
  border-radius: 20px;
  padding: 12px 18px;
  margin-bottom: 14px;
  border: 1px solid rgba(116,192,252,0.15);
  box-shadow: 0 4px 20px rgba(0,0,0,0.4);
}
.hud-pet {
  display: flex;
  align-items: center;
  gap: 10px;
}
.pet-avatar {
  font-size: 2.4rem;
  animation: petBob 2s ease-in-out infinite;
  filter: drop-shadow(0 0 8px rgba(255,212,59,0.5));
}
@keyframes petBob {
  0%, 100% { transform: translateY(0) rotate(-3deg); }
  50% { transform: translateY(-6px) rotate(3deg); }
}
.pet-info { display: flex; flex-direction: column; gap: 3px; }
.pet-name { font-weight: 800; font-size: 0.95rem; color: var(--sun); }
.level-badge {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  background: linear-gradient(135deg, #6741D9, #9775FA);
  border-radius: 20px;
  padding: 3px 10px;
  font-size: 0.78rem;
  font-weight: 700;
}
.hud-xp { flex: 1; margin: 0 16px; }
.xp-label {
  display: flex;
  justify-content: space-between;
  font-size: 0.75rem;
  color: var(--muted);
  margin-bottom: 4px;
  font-weight: 600;
}
.xp-track {
  background: rgba(255,255,255,0.1);
  border-radius: 50px;
  height: 10px;
  overflow: hidden;
}
.xp-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--sun), var(--orange));
  border-radius: 50px;
  transition: width 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
  box-shadow: 0 0 8px rgba(255,212,59,0.6);
}
.hud-stars {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 2px;
}
.stars-num {
  font-family: 'Fredoka One', cursive;
  font-size: 1.5rem;
  color: var(--sun);
  line-height: 1;
  text-shadow: 0 0 10px rgba(255,212,59,0.6);
}
.stars-label { font-size: 0.7rem; color: var(--muted); font-weight: 700; }

/* ===== STREAK BANNER ===== */
.streak-banner {
  display: none;
  justify-content: center;
  align-items: center;
  gap: 8px;
  background: linear-gradient(135deg, #FF922B, #FFD43B);
  border-radius: 50px;
  padding: 8px 20px;
  margin-bottom: 12px;
  font-family: 'Fredoka One', cursive;
  font-size: 1.1rem;
  color: #1A1A1A;
  box-shadow: 0 4px 20px rgba(255,146,43,0.5);
  animation: streakPop 0.5s cubic-bezier(0.34,1.56,0.64,1);
}
@keyframes streakPop {
  from { transform: scale(0.7); opacity: 0; }
  to { transform: scale(1); opacity: 1; }
}

/* ===== TOPIC GRID ===== */
.section-title {
  font-family: 'Fredoka One', cursive;
  font-size: 1.1rem;
  color: var(--muted);
  margin-bottom: 10px;
  letter-spacing: 1px;
  text-transform: uppercase;
}
.topic-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 10px;
  margin-bottom: 16px;
}
.topic-btn {
  background: var(--card);
  border: 2px solid rgba(255,255,255,0.08);
  border-radius: 18px;
  padding: 14px 6px;
  cursor: pointer;
  text-align: center;
  font-family: 'Baloo 2', cursive;
  font-weight: 800;
  font-size: 0.8rem;
  transition: all 0.22s;
  color: var(--muted);
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 5px;
  position: relative;
  overflow: hidden;
}
.topic-btn::before {
  content: '';
  position: absolute; inset: 0;
  opacity: 0;
  transition: opacity 0.2s;
}
.topic-btn:hover { transform: translateY(-3px); border-color: rgba(255,255,255,0.2); color: white; }
.topic-btn:hover::before { opacity: 0.08; }
.topic-btn .t-icon { font-size: 1.8rem; }
.topic-btn .t-stars { font-size: 0.7rem; color: var(--sun); margin-top: 2px; }

.topic-btn.t-add { --tc: #FF6B6B; }
.topic-btn.t-sub { --tc: #FF922B; }
.topic-btn.t-mul { --tc: #CC5DE8; }
.topic-btn.t-cnt { --tc: #51CF66; }
.topic-btn.t-frac { --tc: #20C997; }
.topic-btn.t-place { --tc: #74C0FC; }
.topic-btn.active {
  background: linear-gradient(135deg, color-mix(in srgb, var(--tc) 60%, transparent), color-mix(in srgb, var(--tc) 30%, transparent));
  border-color: var(--tc);
  color: white;
  transform: translateY(-4px);
  box-shadow: 0 8px 20px color-mix(in srgb, var(--tc) 40%, transparent);
}

/* ===== QUIZ CARD ===== */
.quiz-card {
  background: var(--card);
  border-radius: 28px;
  padding: 28px 24px;
  border: 1px solid rgba(116,192,252,0.12);
  box-shadow: 0 12px 40px rgba(0,0,0,0.5);
  animation: cardIn 0.45s cubic-bezier(0.34, 1.56, 0.64, 1);
  margin-bottom: 14px;
}
@keyframes cardIn {
  from { transform: scale(0.88) translateY(30px); opacity: 0; }
  to { transform: scale(1) translateY(0); opacity: 1; }
}

.q-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 18px;
}
.q-topic-badge {
  display: inline-flex;
  align-items: center;
  gap: 5px;
  border-radius: 50px;
  padding: 5px 14px;
  font-size: 0.8rem;
  font-weight: 800;
  background: rgba(255,255,255,0.07);
}
.tries-dots { display: flex; gap: 5px; }
.try-dot {
  width: 12px; height: 12px;
  border-radius: 50%;
  background: var(--green);
  box-shadow: 0 0 6px var(--green);
}
.try-dot.used { background: var(--red); box-shadow: 0 0 6px var(--red); }
.try-dot.empty { background: rgba(255,255,255,0.15); box-shadow: none; }

.question-display {
  font-family: 'Fredoka One', cursive;
  font-size: 3rem;
  text-align: center;
  margin: 8px 0 16px;
  color: white;
  letter-spacing: 2px;
  text-shadow: 0 2px 10px rgba(116,192,252,0.3);
}
.visual-area {
  text-align: center;
  font-size: 1.8rem;
  min-height: 50px;
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  align-items: center;
  gap: 4px;
  margin-bottom: 16px;
  background: rgba(0,0,0,0.2);
  border-radius: 16px;
  padding: 12px;
  line-height: 1.6;
}
.visual-area.hidden { display: none; }

.options-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 12px;
}
.opt-btn {
  background: var(--card2);
  border: 2px solid rgba(255,255,255,0.1);
  border-radius: 16px;
  padding: 16px 10px;
  font-family: 'Fredoka One', cursive;
  font-size: 1.8rem;
  cursor: pointer;
  transition: all 0.18s;
  color: white;
  position: relative;
  overflow: hidden;
}
.opt-btn::after {
  content: '';
  position: absolute; inset: 0;
  background: white;
  opacity: 0;
  transition: opacity 0.15s;
  border-radius: 14px;
}
.opt-btn:hover:not(:disabled) { transform: scale(1.05); border-color: rgba(255,255,255,0.3); }
.opt-btn:hover:not(:disabled)::after { opacity: 0.05; }
.opt-btn.correct {
  background: linear-gradient(135deg, #2D6A4F, #52B788);
  border-color: var(--green);
  animation: correctBounce 0.5s cubic-bezier(0.34,1.56,0.64,1);
  box-shadow: 0 0 20px rgba(81,207,102,0.4);
}
.opt-btn.wrong {
  background: linear-gradient(135deg, #6B1C1C, #C1392B);
  border-color: var(--red);
  animation: shakeBtn 0.4s;
  box-shadow: 0 0 15px rgba(255,107,107,0.3);
}
.opt-btn.reveal-correct {
  background: linear-gradient(135deg, #2D6A4F, #52B788);
  border-color: var(--green);
  box-shadow: 0 0 20px rgba(81,207,102,0.4);
}
.opt-btn:disabled { cursor: not-allowed; }
@keyframes correctBounce {
  0% { transform: scale(1); }
  40% { transform: scale(1.18); }
  100% { transform: scale(1.05); }
}
@keyframes shakeBtn {
  0%, 100% { transform: translateX(0); }
  20% { transform: translateX(-10px); }
  60% { transform: translateX(10px); }
}

/* ===== FEEDBACK BAR ===== */
.feedback-bar {
  margin-top: 16px;
  min-height: 44px;
  border-radius: 16px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: 'Fredoka One', cursive;
  font-size: 1.3rem;
  transition: all 0.3s;
  padding: 8px 16px;
}
.feedback-bar.correct-fb {
  background: linear-gradient(135deg, rgba(81,207,102,0.2), rgba(32,201,151,0.2));
  border: 1px solid rgba(81,207,102,0.3);
  color: #74EFA0;
}
.feedback-bar.wrong-fb {
  background: linear-gradient(135deg, rgba(255,107,107,0.15), rgba(255,146,43,0.15));
  border: 1px solid rgba(255,107,107,0.3);
  color: #FF9A9A;
}

/* ===== TUTORIAL PANEL ===== */
.tutorial-panel {
  background: linear-gradient(135deg, #1A3A5C, #0D2137);
  border: 2px solid rgba(116,192,252,0.3);
  border-radius: 24px;
  padding: 22px;
  margin-top: 12px;
  animation: tutIn 0.5s cubic-bezier(0.34,1.56,0.64,1);
  box-shadow: 0 8px 30px rgba(0,0,0,0.5), inset 0 1px 0 rgba(116,192,252,0.1);
}
@keyframes tutIn {
  from { transform: translateY(20px) scale(0.95); opacity: 0; }
  to { transform: translateY(0) scale(1); opacity: 1; }
}
.tutorial-header {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 16px;
}
.tutorial-header .owl { font-size: 2.2rem; animation: owlNod 1.5s ease-in-out infinite; }
@keyframes owlNod {
  0%, 100% { transform: rotate(-5deg); }
  50% { transform: rotate(5deg); }
}
.tutorial-header h3 {
  font-family: 'Fredoka One', cursive;
  font-size: 1.3rem;
  color: var(--sky);
}
.tutorial-header p { font-size: 0.85rem; color: var(--muted); font-weight: 600; }

.steps-container { display: flex; flex-direction: column; gap: 10px; }
.step {
  display: flex;
  align-items: flex-start;
  gap: 12px;
  background: rgba(255,255,255,0.04);
  border-radius: 14px;
  padding: 12px 14px;
  border-left: 3px solid var(--sky);
  animation: stepIn 0.4s ease both;
}
.step:nth-child(1) { animation-delay: 0.1s; }
.step:nth-child(2) { animation-delay: 0.25s; }
.step:nth-child(3) { animation-delay: 0.4s; }
@keyframes stepIn {
  from { transform: translateX(-15px); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
}
.step-num {
  min-width: 28px; height: 28px;
  background: linear-gradient(135deg, var(--sky), var(--purple));
  border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-family: 'Fredoka One', cursive;
  font-size: 0.9rem;
  color: white;
  flex-shrink: 0;
}
.step-text { font-size: 0.95rem; font-weight: 600; color: var(--text); line-height: 1.5; }
.step-math {
  font-family: 'Fredoka One', cursive;
  font-size: 1.4rem;
  color: var(--sun);
  display: block;
  margin-top: 4px;
}
.step-visual { font-size: 1.4rem; display: block; margin-top: 4px; letter-spacing: 3px; }

.try-again-btn {
  display: block;
  width: 100%;
  margin-top: 16px;
  background: linear-gradient(135deg, #6741D9, #9775FA);
  border: none;
  border-radius: 16px;
  padding: 14px;
  font-family: 'Fredoka One', cursive;
  font-size: 1.3rem;
  color: white;
  cursor: pointer;
  transition: all 0.2s;
  box-shadow: 0 6px 20px rgba(103,65,217,0.4);
}
.try-again-btn:hover { transform: translateY(-2px) scale(1.02); box-shadow: 0 10px 25px rgba(103,65,217,0.5); }

/* ===== RETRY QUESTION CARD ===== */
.retry-label {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  font-family: 'Fredoka One', cursive;
  font-size: 1rem;
  color: var(--sun);
  margin-bottom: 10px;
  background: rgba(255,212,59,0.1);
  border: 1px solid rgba(255,212,59,0.2);
  border-radius: 50px;
  padding: 7px 18px;
}

/* ===== NEXT BUTTON ===== */
.next-btn {
  display: none;
  width: 100%;
  background: linear-gradient(135deg, var(--sun), var(--orange));
  border: none;
  border-radius: 16px;
  padding: 16px;
  font-family: 'Fredoka One', cursive;
  font-size: 1.4rem;
  color: #1A1A1A;
  cursor: pointer;
  transition: all 0.2s;
  box-shadow: 0 6px 20px rgba(255,146,43,0.4);
  animation: nextGlow 2s ease-in-out infinite;
  margin-top: 12px;
}
.next-btn:hover { transform: translateY(-3px) scale(1.02); }
@keyframes nextGlow {
  0%, 100% { box-shadow: 0 6px 20px rgba(255,146,43,0.4); }
  50% { box-shadow: 0 6px 30px rgba(255,146,43,0.7), 0 0 0 4px rgba(255,212,59,0.1); }
}

/* ===== LEVEL UP MODAL ===== */
.modal-overlay {
  display: none;
  position: fixed; inset: 0;
  background: rgba(0,0,0,0.7);
  z-index: 100;
  align-items: center;
  justify-content: center;
  backdrop-filter: blur(4px);
}
.modal-overlay.show { display: flex; }
.level-modal {
  background: linear-gradient(135deg, #1A2F4A, #0D2137);
  border: 2px solid rgba(255,212,59,0.4);
  border-radius: 30px;
  padding: 40px 32px;
  text-align: center;
  max-width: 340px;
  width: 90%;
  box-shadow: 0 20px 60px rgba(0,0,0,0.8), 0 0 0 1px rgba(255,255,255,0.05);
  animation: modalPop 0.6s cubic-bezier(0.34,1.56,0.64,1);
}
@keyframes modalPop {
  from { transform: scale(0.5) rotate(-5deg); opacity: 0; }
  to { transform: scale(1) rotate(0deg); opacity: 1; }
}
.modal-pet { font-size: 5rem; display: block; animation: spin 0.8s ease; margin-bottom: 10px; }
@keyframes spin { from { transform: rotate(-20deg) scale(0.5); } to { transform: rotate(0deg) scale(1); } }
.modal-title {
  font-family: 'Fredoka One', cursive;
  font-size: 2.2rem;
  background: linear-gradient(135deg, var(--sun), var(--orange));
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  background-clip: text;
  margin-bottom: 6px;
}
.modal-sub { color: var(--muted); font-weight: 700; font-size: 1rem; margin-bottom: 6px; }
.modal-lvl {
  font-family: 'Fredoka One', cursive;
  font-size: 3.5rem;
  color: white;
  margin: 8px 0;
  text-shadow: 0 0 20px rgba(116,192,252,0.5);
}
.modal-unlock { 
  font-size: 0.9rem; 
  color: var(--teal); 
  font-weight: 700;
  background: rgba(32,201,151,0.1);
  border: 1px solid rgba(32,201,151,0.2);
  border-radius: 12px;
  padding: 8px 16px;
  margin: 12px 0;
}
.modal-btn {
  background: linear-gradient(135deg, #6741D9, #9775FA);
  border: none;
  border-radius: 50px;
  padding: 14px 40px;
  font-family: 'Fredoka One', cursive;
  font-size: 1.3rem;
  color: white;
  cursor: pointer;
  margin-top: 14px;
  box-shadow: 0 6px 20px rgba(103,65,217,0.4);
  transition: all 0.2s;
}
.modal-btn:hover { transform: scale(1.06); }

/* ===== CONFETTI ===== */
.confetti-wrap {
  position: fixed; inset: 0;
  pointer-events: none; z-index: 200;
  display: none;
}
.cp {
  position: absolute;
  width: 10px; height: 10px;
  border-radius: 2px;
  animation: cf var(--d, 1s) var(--del, 0s) ease-in both;
}
@keyframes cf {
  0% { transform: translateY(-20px) rotate(0deg) scale(1); opacity: 1; }
  100% { transform: translateY(110vh) rotate(900deg) scale(0.3); opacity: 0; }
}

/* ===== WELCOME ===== */
.welcome {
  text-align: center;
  padding: 30px 10px;
}
.welcome-emoji { font-size: 5rem; display: block; animation: float 2s ease-in-out infinite; }
@keyframes float {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-12px); }
}
.welcome h2 {
  font-family: 'Fredoka One', cursive;
  font-size: 1.8rem;
  color: var(--sky);
  margin: 12px 0 8px;
}
.welcome p { color: var(--muted); font-weight: 600; font-size: 1rem; }

/* ===== BOSS CHALLENGE LABEL ===== */
.boss-banner {
  display: none;
  text-align: center;
  background: linear-gradient(135deg, rgba(255,107,107,0.2), rgba(204,93,232,0.2));
  border: 1px solid rgba(255,107,107,0.3);
  border-radius: 14px;
  padding: 10px;
  margin-bottom: 10px;
  font-family: 'Fredoka One', cursive;
  font-size: 1.1rem;
  color: #FF9A9A;
  animation: bossPulse 1.5s ease-in-out infinite;
}
@keyframes bossPulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.7; }
}

/* ===== QUEST SECTION HIDE/SHOW ===== */
#questSection, #welcomeSection {
  transition: all 0.35s ease;
  overflow: hidden;
}
#questSection.hidden, #welcomeSection.hidden {
  max-height: 0 !important;
  opacity: 0;
  margin: 0;
  pointer-events: none;
}

/* ===== BACK BUTTON ===== */
.back-btn {
  display: flex;
  align-items: center;
  gap: 6px;
  background: rgba(255,255,255,0.07);
  border: 1px solid rgba(255,255,255,0.15);
  border-radius: 50px;
  padding: 8px 18px;
  font-family: 'Baloo 2', cursive;
  font-weight: 700;
  font-size: 0.9rem;
  color: var(--muted);
  cursor: pointer;
  transition: all 0.2s;
  margin-bottom: 12px;
}
.back-btn:hover {
  background: rgba(255,255,255,0.12);
  color: var(--text);
  border-color: rgba(255,255,255,0.25);
  transform: translateX(-2px);
}

@media (max-width: 440px) {
  .question-display { font-size: 2.2rem; }
  .topic-grid { grid-template-columns: repeat(2, 1fr); }
  .hud { flex-wrap: wrap; gap: 8px; }
}
</style>
</head>
<body>

<div id="starfield"></div>
<div class="confetti-wrap" id="confetti"></div>

<!-- LEVEL UP MODAL -->
<div class="modal-overlay" id="levelModal">
  <div class="level-modal">
    <span class="modal-pet" id="modalPet"></span>
    <div class="modal-title">LEVEL UP! üéâ</div>
    <div class="modal-sub" id="modalPetName"></div>
    <div class="modal-lvl" id="modalLvlNum"></div>
    <div class="modal-unlock" id="modalUnlock"></div>
    <button class="modal-btn" onclick="closeModal()">Let's Go! üöÄ</button>
  </div>
</div>

<div class="app">

  <!-- WELCOME -->
  <div id="welcomeSection">
    <div class="welcome">
      <span class="welcome-emoji">üè∞</span>
      <h2>Welcome to Math Kingdom!</h2>
      <p>Choose a quest below to begin your adventure!<br>Answer correctly to earn ‚≠ê stars and level up your pet!</p>
    </div>
  </div>

  <!-- HUD -->
  <div class="hud">
    <div class="hud-pet">
      <div class="pet-avatar" id="petEmoji">üê£</div>
      <div class="pet-info">
        <div class="pet-name" id="petName">Pip</div>
        <div class="level-badge">‚ö° Level <span id="levelNum">1</span></div>
      </div>
    </div>
    <div class="hud-xp">
      <div class="xp-label">
        <span>XP</span>
        <span id="xpLabel">0 / 50</span>
      </div>
      <div class="xp-track">
        <div class="xp-fill" id="xpBar" style="width:0%"></div>
      </div>
    </div>
    <div class="hud-stars">
      <div class="stars-num" id="starsNum">0</div>
      <div class="stars-label">‚≠ê Stars</div>
    </div>
  </div>

  <!-- STREAK -->
  <div class="streak-banner" id="streakBanner">üî• <span id="streakText"></span> Streak!</div>

  <!-- BOSS BANNER -->
  <div class="boss-banner" id="bossBanner">üëπ BOSS CHALLENGE! Can you answer 3 in a row?</div>

  <!-- TOPICS -->
  <div id="questSection">
  <div class="section-title">Choose Your Quest</div>
  <div class="topic-grid">
    <button class="topic-btn t-add" onclick="selectTopic('addition')">
      <span class="t-icon">‚ûï</span>Addition
      <span class="t-stars" id="stars-addition">‚≠ê 0</span>
    </button>
    <button class="topic-btn t-sub" onclick="selectTopic('subtraction')">
      <span class="t-icon">‚ûñ</span>Subtract
      <span class="t-stars" id="stars-subtraction">‚≠ê 0</span>
    </button>
    <button class="topic-btn t-mul" onclick="selectTopic('multiplication')">
      <span class="t-icon">‚úñÔ∏è</span>Multiply
      <span class="t-stars" id="stars-multiplication">‚≠ê 0</span>
    </button>
    <button class="topic-btn t-cnt" onclick="selectTopic('counting')">
      <span class="t-icon">üî¢</span>Counting
      <span class="t-stars" id="stars-counting">‚≠ê 0</span>
    </button>
    <button class="topic-btn t-frac" onclick="selectTopic('fractions')">
      <span class="t-icon">üçï</span>Fractions
      <span class="t-stars" id="stars-fractions">‚≠ê 0</span>
    </button>
    <button class="topic-btn t-place" onclick="selectTopic('placevalue')">
      <span class="t-icon">üì¶</span>Place Value
      <span class="t-stars" id="stars-placevalue">‚≠ê 0</span>
    </button>
  </div><!-- end topic-grid -->
  </div><!-- end questSection -->

  <!-- BACK BUTTON (shown during gameplay) -->
  <button class="back-btn" id="backBtn" onclick="goHome()" style="display:none">üè† Change Quest</button>

  <!-- MAIN GAME AREA -->
  <div id="gameArea"></div>

  <button class="next-btn" id="nextBtn" onclick="nextQuestion()">Next Question ‚û°Ô∏è</button>

</div>

<script>
// ============================================================
// STATE ‚Äî persisted fields loaded from localStorage
// ============================================================
const SAVE_KEY = 'mathKingdomSave';

function loadSave() {
  try {
    const saved = localStorage.getItem(SAVE_KEY);
    if (saved) return JSON.parse(saved);
  } catch(e) {}
  return null;
}

function saveState() {
  try {
    const toSave = {
      level: state.level,
      xp: state.xp,
      xpToNext: state.xpToNext,
      stars: state.stars,
      topicStars: state.topicStars,
    };
    localStorage.setItem(SAVE_KEY, JSON.stringify(toSave));
  } catch(e) {}
}

const saved = loadSave();
let state = {
  topic: null,
  level:      saved?.level      ?? 1,
  xp:         saved?.xp         ?? 0,
  xpToNext:   saved?.xpToNext   ?? 50,
  stars:      saved?.stars      ?? 0,
  topicStars: saved?.topicStars ?? { addition:0, subtraction:0, multiplication:0, counting:0, fractions:0, placevalue:0 },
  streak: 0,
  currentQ: null,
  triesLeft: 2,
  totalTries: 2,
  phase: 'question',
  isRetry: false,
  answered: false,
};

// Pets by level
const pets = [
  { emoji:'üê£', name:'Pip',    unlock:'Math Hatchling!' },
  { emoji:'üê•', name:'Sunny',  unlock:'Baby Chick Unlocked! üê•' },
  { emoji:'ü¶ä', name:'Foxy',   unlock:'Clever Fox Unlocked! ü¶ä' },
  { emoji:'ü¶ã', name:'Flutter',unlock:'Butterfly Unlocked! ü¶ã' },
  { emoji:'ü¶Ñ', name:'Sparkle',unlock:'Unicorn Unlocked! ü¶Ñ' },
  { emoji:'üêâ', name:'Drago',  unlock:'DRAGON Unlocked! üêâ' },
  { emoji:'üåü', name:'Starlord',unlock:'Star Guardian Unlocked! üåü' },
];

// ============================================================
// STARFIELD
// ============================================================
(function buildStars() {
  const sf = document.getElementById('starfield');
  for (let i = 0; i < 80; i++) {
    const s = document.createElement('div');
    s.className = 'twinkling-star';
    const sz = Math.random() * 3 + 1;
    s.style.cssText = `width:${sz}px;height:${sz}px;left:${Math.random()*100}%;top:${Math.random()*100}%;--dur:${2+Math.random()*4}s;animation-delay:${Math.random()*4}s`;
    sf.appendChild(s);
  }
})();

// ============================================================
// QUESTION GENERATORS
// ============================================================
function randInt(a, b) { return Math.floor(Math.random()*(b-a+1))+a; }
function shuffle(arr) {
  const a=[...arr];
  for(let i=a.length-1;i>0;i--){const j=randInt(0,i);[a[i],a[j]]=[a[j],a[i]];}
  return a;
}
function makeWrongs(ans, count, min, max, isStr=false) {
  if (isStr) return [];
  const s=new Set(); let tries=0;
  while(s.size<count && tries<200){tries++;const d=randInt(1,Math.max(3, Math.ceil(ans*0.3)||3))*(Math.random()<.5?1:-1);const w=ans+d;if(w!==ans&&w>=min&&w<=max)s.add(w);}
  let fill=min; while(s.size<count){if(fill!==ans)s.add(fill);fill++;}
  return [...s].slice(0,count);
}

const generators = {
  addition(retry=false) {
    const max = state.level <= 2 ? 20 : state.level <= 4 ? 50 : 99;
    const a = randInt(1, Math.floor(max/2)), b = randInt(1, Math.floor(max/2));
    const ans = a + b;
    const vis = a<=8 && b<=8 ? 'üü°'.repeat(a) + ' ‚ûï ' + 'üü°'.repeat(b) : null;
    const steps = [
      { text: `We're adding ${a} and ${b} together.`, math: `${a} + ${b}` },
      { text: `Start at ${a} on the number line, then count up ${b} more.`, math: `${a} ‚Üí ${ans}`, visual: a<=8&&b<=6?'1Ô∏è‚É£'.repeat(a)+'  ‚û°Ô∏è  '+'‚ûï'.repeat(b):null },
      { text: `When you count up ${b} from ${a}, you land on...`, math: `${a} + ${b} = ${ans}` },
    ];
    return { q: `${a} + ${b} = ?`, ans, opts: shuffle([ans,...makeWrongs(ans,3,0,max+10)]), vis, steps };
  },
  subtraction(retry=false) {
    const max = state.level <= 2 ? 20 : state.level <= 4 ? 50 : 99;
    const a = randInt(3, max), b = randInt(1, a);
    const ans = a - b;
    const steps = [
      { text: `We start with ${a} things.`, math: `${a}`, visual: a<=10?'üçé'.repeat(a):null },
      { text: `We take away ${b} of them.`, math: `Take away ${b}`, visual: a<=10?'üçé'.repeat(ans)+'‚ùå'.repeat(b):null },
      { text: `Count how many are left ‚Äî that's our answer!`, math: `${a} ‚àí ${b} = ${ans}` },
    ];
    return { q: `${a} ‚àí ${b} = ?`, ans, opts: shuffle([ans,...makeWrongs(ans,3,0,max)]), vis: null, steps };
  },
  multiplication(retry=false) {
    const maxFactor = state.level <= 3 ? 5 : 10;
    const a = randInt(2, maxFactor), b = randInt(2, maxFactor);
    const ans = a * b;
    const vis = a<=5&&b<=5 ? Array(a).fill('üîµ'.repeat(b)).join(' | ') : null;
    const steps = [
      { text: `${a} √ó ${b} means ${a} groups of ${b}.`, math: `${a} groups of ${b}` },
      { text: `Draw ${a} groups, put ${b} dots in each.`, visual: a<=5&&b<=5?Array(a).fill('‚óè'.repeat(b)).join('  '):null },
      { text: `Count ALL the dots together!`, math: `${a} √ó ${b} = ${ans}` },
    ];
    return { q: `${a} √ó ${b} = ?`, ans, opts: shuffle([ans,...makeWrongs(ans,3,0,maxFactor*maxFactor+5)]), vis, steps };
  },
  counting(retry=false) {
    const type = randInt(0, 2);
    if (type === 0) {
      const n = state.level<=2 ? randInt(5,15) : randInt(10,25);
      const emojis = ['üçé','‚≠ê','üêù','üå∏','üéà','ü¶ã','üç™','üå∫'];
      const e = emojis[randInt(0,emojis.length-1)];
      const ans = n;
      const steps = [
        { text: `Count each ${e} one by one.`, math: `Touch each one as you count!` },
        { text: `Try counting them in groups of 2 or 5 ‚Äî it's faster!`, math: `Group counting trick üí°` },
        { text: `Count them all carefully...`, math: `Total = ${ans} ${e}s` },
      ];
      return { q: `How many ${e}?`, ans, opts: shuffle([ans,...makeWrongs(ans,3,Math.max(1,ans-5),ans+5)]), vis: e.repeat(n), steps };
    } else if (type === 1) {
      const by = [2,5,10][randInt(0,2)];
      const start = by * randInt(1,5);
      const ans = start + by;
      const seq = [start-by*2, start-by, start].filter(x=>x>0);
      const steps = [
        { text: `We're skip counting by ${by}s.`, math: `+${by} each time` },
        { text: `The pattern so far: ${seq.join(', ')}, ${start}, ___`, math: `Each number goes up by ${by}` },
        { text: `${start} + ${by} = ?`, math: `${start} + ${by} = ${ans}` },
      ];
      return { q: `Skip count by ${by}s:\n${start}, ___?`, ans, opts: shuffle([ans,...makeWrongs(ans,3,start,start+by*4)]), vis: null, steps };
    } else {
      const n = randInt(1, 40);
      const ans = n%2===0 ? 'Even' : 'Odd';
      const steps = [
        { text: `Even numbers can be split into 2 equal groups. Odd numbers can't!`, math: `Even = ...2,4,6,8,10...` },
        { text: `${n} ‚Äî does it end in 0,2,4,6 or 8? Then it's even. Ends in 1,3,5,7,9? Then it's odd!`, math: `${n} ends in ${n%10}` },
        { text: `So ${n} is...`, math: `${ans}!` },
      ];
      return { q: `Is ${n} odd or even?`, ans, opts: shuffle(['Even','Odd','Both','Neither']), vis: null, steps, strOpts:true };
    }
  },
  fractions(retry=false) {
    const d = [2,3,4][randInt(0,2)];
    const n = randInt(1,d-1);
    const ans = `${n}/${d}`;
    const shapes = {'1/2':['üü¶','‚¨ú'],'2/2':['üü¶','üü¶'],'1/3':['üü¶','‚¨ú','‚¨ú'],'2/3':['üü¶','üü¶','‚¨ú'],'1/4':['üü¶','‚¨ú','‚¨ú','‚¨ú'],'2/4':['üü¶','üü¶','‚¨ú','‚¨ú'],'3/4':['üü¶','üü¶','üü¶','‚¨ú']};
    const vis = (shapes[ans]||['üü¶']).join('');
    const steps = [
      { text: `A fraction shows parts of a whole.`, math: `Bottom number = total pieces` },
      { text: `The shape is cut into ${d} equal pieces.`, math: `Denominator = ${d}` },
      { text: `${n} piece${n>1?'s are':' is'} colored blue üü¶. That's the top number!`, math: `${n}/${d}` },
    ];
    const pool=['1/2','1/3','2/3','1/4','3/4','2/4'];
    const wrongs=pool.filter(x=>x!==ans).slice(0,3);
    return { q: `What fraction is üü¶ shaded?`, ans, opts: shuffle([ans,...wrongs]), vis, steps };
  },
  placevalue(retry=false) {
    const max = state.level<=3 ? 99 : 999;
    if (max===99) {
      const num = randInt(10,99);
      const tens = Math.floor(num/10), ones = num%10;
      const type = randInt(0,1);
      if (type===0) {
        const ans = `${tens}T ${ones}O`;
        const steps = [
          { text: `Every number has a TENS place and a ONES place.`, math: `Example: 47 ‚Üí 4 tens, 7 ones` },
          { text: `In ${num}, the first digit (${tens}) tells us TENS.`, math: `${tens} √ó 10 = ${tens*10}` },
          { text: `The second digit (${ones}) tells us ONES.`, math: `${num} = ${tens} tens + ${ones} ones` },
        ];
        const wrong=[`${ones}T ${tens}O`,`${tens+1}T ${ones}O`,`${tens}T ${ones+1}O`];
        return { q: `What is ${num}?`, ans, opts: shuffle([ans,...wrong]), vis: 'üì¶'.repeat(tens)+' '+'üü¶'.repeat(ones), steps };
      } else {
        const ans = num;
        const steps = [
          { text: `${tens} tens means ${tens} groups of 10.`, math: `${tens} √ó 10 = ${tens*10}` },
          { text: `${ones} ones means ${ones} single units.`, math: `+ ${ones}` },
          { text: `Add them together!`, math: `${tens*10} + ${ones} = ${ans}` },
        ];
        return { q: `${tens} tens and ${ones} ones = ?`, ans, opts: shuffle([ans,...makeWrongs(ans,3,10,99)]), vis: 'üì¶'.repeat(tens)+' '+'üü¶'.repeat(ones), steps };
      }
    }
  }
};

// ============================================================
// TOPIC SELECTION
// ============================================================
function selectTopic(topic) {
  state.topic = topic;
  state.triesLeft = 2;
  state.phase = 'question';
  state.isRetry = false;
  document.querySelectorAll('.topic-btn').forEach(b=>b.classList.remove('active'));
  document.querySelector(`.topic-btn.t-${topic.slice(0,3)}`).classList.add('active');
  document.getElementById('nextBtn').style.display='none';

  // Hide quest section, show back button, hide welcome
  document.getElementById('questSection').classList.add('hidden');
  document.getElementById('welcomeSection').classList.add('hidden');
  document.getElementById('backBtn').style.display='flex';

  renderQuestion(false);
}

// ============================================================
// GO HOME
// ============================================================
function goHome() {
  state.topic = null;
  state.phase = 'question';
  state.answered = false;
  document.getElementById('nextBtn').style.display='none';
  document.getElementById('backBtn').style.display='none';
  document.getElementById('streakBanner').style.display='none';

  // Show quest section and welcome again
  document.getElementById('questSection').classList.remove('hidden');
  document.getElementById('welcomeSection').classList.remove('hidden');
  document.querySelectorAll('.topic-btn').forEach(b=>b.classList.remove('active'));

  document.getElementById('gameArea').innerHTML = '';
}

// ============================================================
// RENDER QUESTION
// ============================================================
function renderQuestion(isRetry=false) {
  state.answered = false;
  state.triesLeft = 2;
  state.phase = 'question';
  state.isRetry = isRetry;
  const gen = generators[state.topic];
  const q = gen(isRetry);
  state.currentQ = q;
  document.getElementById('nextBtn').style.display='none';

  let html = '';
  if (isRetry) {
    html += `<div class="retry-label">üîÑ Similar question ‚Äî you've got this!</div>`;
  }

  const topicColor = {addition:'#FF6B6B',subtraction:'#FF922B',multiplication:'#CC5DE8',counting:'#51CF66',fractions:'#20C997',placevalue:'#74C0FC'};
  const topicIcon = {addition:'‚ûï',subtraction:'‚ûñ',multiplication:'‚úñÔ∏è',counting:'üî¢',fractions:'üçï',placevalue:'üì¶'};
  const tc = topicColor[state.topic];

  html += `<div class="quiz-card" id="quizCard">
    <div class="q-header">
      <div class="q-topic-badge" style="color:${tc};border:1px solid ${tc}40;">${topicIcon[state.topic]} ${state.topic.charAt(0).toUpperCase()+state.topic.slice(1)}</div>
      <div class="tries-dots" id="triesDots">
        <div class="try-dot" id="dot0"></div>
        <div class="try-dot" id="dot1"></div>
      </div>
    </div>
    <div class="question-display">${q.q.replace('\n','<br>')}</div>
    <div class="visual-area hidden" id="visArea">${q.vis || ''}</div>
    <div class="options-grid" id="optsGrid">
      ${q.opts.map(opt=>`<button class="opt-btn" onclick="checkAnswer(this,'${opt}')">${opt}</button>`).join('')}
    </div>
    <div class="feedback-bar" id="feedbackBar"></div>
  </div>`;

  document.getElementById('gameArea').innerHTML = html;
}

// ============================================================
// CHECK ANSWER
// ============================================================
function checkAnswer(btn, selected) {
  if (state.answered) return;

  const correct = String(selected) === String(state.currentQ.ans);
  const allBtns = document.querySelectorAll('.opt-btn');
  
  if (correct) {
    state.answered = true;
    allBtns.forEach(b=>b.disabled=true);
    btn.classList.add('correct');
    // Reveal correct on wrong buttons already fine since they picked right
    
    // Award XP and stars
    const xpGain = state.isRetry ? 5 : (state.triesLeft === 2 ? 15 : 10);
    const starGain = state.isRetry ? 0 : (state.triesLeft === 2 ? 1 : 1);
    
    if (!state.isRetry) {
      state.stars += starGain;
      state.topicStars[state.topic] += starGain;
      document.getElementById('stars-'+state.topic).textContent = `‚≠ê ${state.topicStars[state.topic]}`;
      document.getElementById('starsNum').textContent = state.stars;
    }

    addXP(xpGain);

    state.streak++;
    updateStreak();

    const msgs = state.isRetry 
      ? ['You learned it! üåü','Nailed it! üéØ','Practice makes perfect! üí™']
      : state.triesLeft===2
        ? ['Perfect! üåü','Amazing! üèÜ','Superstar! ‚≠ê','Brilliant! üéâ','You Rock! üî•']
        : ['Got it! Great job! üí™','You figured it out! üåà'];
    
    const fb = document.getElementById('feedbackBar');
    fb.className = 'feedback-bar correct-fb';
    fb.textContent = msgs[randInt(0, msgs.length-1)];
    
    if (!state.isRetry) launchConfetti();
    document.getElementById('nextBtn').style.display='block';

  } else {
    btn.classList.add('wrong');
    btn.disabled = true;
    state.triesLeft--;
    state.streak = 0;
    document.getElementById('streakBanner').style.display='none';

    if (state.triesLeft > 0) {
      // Update try dot
      const dotIdx = 2 - state.triesLeft - 1;
      const dot = document.getElementById('dot' + dotIdx);
      if(dot) dot.classList.add('used');

      // Reveal visual hint on second try
      const visArea = document.getElementById('visArea');
      if (visArea && state.currentQ.vis) {
        visArea.classList.remove('hidden');
        visArea.style.animation = 'none';
        void visArea.offsetWidth;
        visArea.style.animation = 'cardIn 0.4s cubic-bezier(0.34,1.56,0.64,1)';
      }

      const fb = document.getElementById('feedbackBar');
      fb.className = 'feedback-bar wrong-fb';
      const hintMsg = state.currentQ.vis ? `Not quite! Here's a hint ‚Äî try again! üí°` : `Not quite! You have ${state.triesLeft} try left üí™`;
      fb.textContent = hintMsg;
    } else {
      // Used both tries ‚Äî show tutorial
      allBtns.forEach(b => {
        b.disabled = true;
        if(String(b.textContent) === String(state.currentQ.ans)) b.classList.add('reveal-correct');
      });
      document.getElementById('dot0').classList.add('used');
      document.getElementById('dot1').classList.add('used');

      const fb = document.getElementById('feedbackBar');
      fb.className = 'feedback-bar wrong-fb';
      fb.textContent = `The answer was ${state.currentQ.ans}. Let's learn how! ü¶â`;
      state.answered = true;
      
      // After a brief pause, show tutorial
      setTimeout(showTutorial, 900);
    }
  }
}

// ============================================================
// TUTORIAL
// ============================================================
function showTutorial() {
  const q = state.currentQ;
  state.phase = 'tutorial';

  let stepsHtml = q.steps.map((s, i) => `
    <div class="step">
      <div class="step-num">${i+1}</div>
      <div class="step-text">
        ${s.text}
        ${s.math ? `<span class="step-math">${s.math}</span>` : ''}
        ${s.visual ? `<span class="step-visual">${s.visual}</span>` : ''}
      </div>
    </div>
  `).join('');

  const tutHtml = `
    <div class="tutorial-panel" id="tutPanel">
      <div class="tutorial-header">
        <div class="owl">ü¶â</div>
        <div>
          <h3>Let's learn together!</h3>
          <p>Professor Hoot shows you how üëá</p>
        </div>
      </div>
      <div class="steps-container">${stepsHtml}</div>
      <button class="try-again-btn" onclick="startRetry()">Try a similar question! üöÄ</button>
    </div>
  `;

  const quizCard = document.getElementById('quizCard');
  if(quizCard) quizCard.insertAdjacentHTML('afterend', tutHtml);
}

// ============================================================
// RETRY
// ============================================================
function startRetry() {
  document.getElementById('gameArea').innerHTML = '';
  renderQuestion(true);
}

// ============================================================
// NEXT QUESTION
// ============================================================
function nextQuestion() {
  document.getElementById('nextBtn').style.display='none';
  renderQuestion(false);
}

// ============================================================
// XP & LEVELING
// ============================================================
function addXP(amount) {
  state.xp += amount;
  if (state.xp >= state.xpToNext) {
    state.xp -= state.xpToNext;
    state.level++;
    state.xpToNext = Math.floor(state.xpToNext * 1.4);
    updateHUD();
    showLevelUp();
  } else {
    updateHUD();
  }
}

function updateHUD() {
  const petIdx = Math.min(state.level-1, pets.length-1);
  const pet = pets[petIdx];
  document.getElementById('petEmoji').textContent = pet.emoji;
  document.getElementById('petName').textContent = pet.name;
  document.getElementById('levelNum').textContent = state.level;
  document.getElementById('xpLabel').textContent = `${state.xp} / ${state.xpToNext}`;
  document.getElementById('xpBar').style.width = `${(state.xp/state.xpToNext)*100}%`;
  document.getElementById('starsNum').textContent = state.stars;
  // Refresh all topic star badges
  Object.keys(state.topicStars).forEach(t => {
    const el = document.getElementById('stars-' + t);
    if (el) el.textContent = `‚≠ê ${state.topicStars[t]}`;
  });
  saveState();
}

function showLevelUp() {
  const petIdx = Math.min(state.level-1, pets.length-1);
  const pet = pets[petIdx];
  document.getElementById('modalPet').textContent = pet.emoji;
  document.getElementById('modalPetName').textContent = pet.name + ' joins your journey!';
  document.getElementById('modalLvlNum').textContent = `Level ${state.level}`;
  document.getElementById('modalUnlock').textContent = pet.unlock;
  document.getElementById('levelModal').classList.add('show');
  launchConfetti(true);
}

function closeModal() {
  document.getElementById('levelModal').classList.remove('show');
}

// ============================================================
// STREAK
// ============================================================
function updateStreak() {
  const sb = document.getElementById('streakBanner');
  if (state.streak >= 3) {
    sb.style.display = 'flex';
    document.getElementById('streakText').textContent = `${state.streak} Correct`;
    sb.style.animation = 'none';
    void sb.offsetWidth;
    sb.style.animation = 'streakPop 0.5s cubic-bezier(0.34,1.56,0.64,1)';
  } else {
    sb.style.display = 'none';
  }
}

// ============================================================
// CONFETTI
// ============================================================
function launchConfetti(big=false) {
  const wrap = document.getElementById('confetti');
  wrap.style.display='block';
  wrap.innerHTML='';
  const colors=['#FF6B6B','#FFD43B','#51CF66','#74C0FC','#CC5DE8','#FF922B','#20C997'];
  const count = big ? 80 : 35;
  for(let i=0;i<count;i++){
    const p=document.createElement('div');
    p.className='cp';
    p.style.cssText=`left:${big?Math.random()*100:25+Math.random()*50}%;top:-10px;background:${colors[randInt(0,colors.length-1)]};--d:${0.8+Math.random()*1.2}s;--del:${Math.random()*0.5}s;transform:rotate(${randInt(0,360)}deg)`;
    wrap.appendChild(p);
  }
  setTimeout(()=>{wrap.style.display='none';},2000);
}

// ============================================================
// INIT
// ============================================================
updateHUD();
</script>
</body>
</html>
